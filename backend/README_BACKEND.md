# Backend API - Verdrehte Welt

## üöÄ Schnellstart

```bash
# Install
npm install

# Setup .env
./setup-env.sh

# Start
npm run dev
```

## üì° API Endpoints

### Public Endpoints

#### Orders
```
POST /api/v1/orders
- Create new order
- Body: { email, vorname, nachname, eventId, positionen, agbAkzeptiert, dsgvoAkzeptiert }
```

#### Events
```
GET /api/v1/events
- Get all events
```

#### PayPal
```
POST /api/v1/payments/paypal/create-order
- Create PayPal order
- Body: { bestellungId }

POST /api/v1/payments/paypal/capture-order
- Capture PayPal payment
- Body: { paypalOrderId }

POST /api/v1/payments/paypal/webhook
- PayPal webhook handler
```

#### Check-In (Public QR Validation)
```
POST /api/v1/checkin/validate
- Validate QR code
- Body: { qrToken }
```

### Admin Endpoints (Require Auth)

#### Admin Login
```
POST /api/v1/admin/login
- Admin login
- Body: { password }
- Returns: { token }
```

#### Admin Scanner
```
POST /api/v1/admin/validate
- Validate ticket (with details)
- Headers: Authorization: Bearer <token>
- Body: { qrToken }

POST /api/v1/admin/checkin
- Check in ticket
- Headers: Authorization: Bearer <token>
- Body: { qrToken }

GET /api/v1/admin/stats?eventId=xxx
- Get statistics
- Headers: Authorization: Bearer <token>
```

## üîß Scripts

### Generate Tickets
```bash
node generate-tickets.js
```

Generates tickets for all paid orders that don't have tickets yet.

### Setup Environment
```bash
./setup-env.sh
```

Adds missing environment variables to `.env` file.

## üì¶ Environment Variables

Required in `.env`:

```bash
# MongoDB
MONGODB_URI=mongodb+srv://...

# PayPal
PAYPAL_CLIENT_ID=...
PAYPAL_CLIENT_SECRET=...
PAYPAL_MODE=sandbox  # or 'live'

# JWT
JWT_SECRET=...  # Auto-generated by setup-env.sh
JWT_EXPIRY=365d

# Admin
ADMIN_PASSWORD=verdrehtewelt2025

# Frontend
FRONTEND_URL=http://localhost:8080  # or production URL

# Email (optional)
MAIL_API_KEY=...  # Resend.com API key

# Server
PORT=3000
NODE_ENV=development
```

## üóÑÔ∏è Database Models

### Order
```javascript
{
  _id: ObjectId,
  email: String,
  vorname: String,
  nachname: String,
  eventId: String,
  positionen: [{
    ticketVarianteId: String,
    bezeichnung: String,
    einzelpreisBrutto: Number,
    menge: Number,
    summe: Number
  }],
  summeBrutto: Number,
  plattformFee: Number,
  waehrung: String,
  status: 'offen' | 'pending' | 'bezahlt' | 'erstattet',
  paypalOrderId: String,
  paypalCaptureId: String,
  bezahlt_at: Date,
  agbAkzeptiert: Boolean,
  dsgvoAkzeptiert: Boolean,
  payoutStatus: String
}
```

### Ticket
```javascript
{
  _id: ObjectId,
  bestellungId: ObjectId (ref: Order),
  eventId: String,
  ticketVarianteId: String,
  bezeichnung: String,
  preis: Number,
  kaeuferEmail: String,
  qrToken: String (JWT),
  qrCodeUrl: String (Data URL),
  status: 'gueltig' | 'eingecheckt' | 'erstattet',
  eingecheckt_at: Date
}
```

## üîí Security

### JWT Tokens
- **QR Tokens:** Signed with JWT_SECRET, expire in 365 days
- **Admin Tokens:** Signed with JWT_SECRET, expire in 24 hours

### Admin Auth
- Password-based login
- Returns JWT token
- Token required for all admin endpoints

### CORS
- Configured to allow frontend origin
- Set FRONTEND_URL in production

## üìß Email Service

### Development
Emails are logged to console (terminal output)

### Production
Uses Resend.com API:
1. Get API key: https://resend.com
2. Add to .env: `MAIL_API_KEY=re_xxxxx`
3. Restart backend

## üêõ Debugging

### Check MongoDB Connection
```bash
curl http://localhost:3000/health
```

### Test Order Creation
```bash
curl -X POST http://localhost:3000/api/v1/orders \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "vorname": "Test",
    "nachname": "User",
    "eventId": "rave-dossenheim-2025",
    "positionen": [{
      "ticketVarianteId": "early-bird",
      "bezeichnung": "Early Bird",
      "einzelpreisBrutto": 8,
      "menge": 1,
      "summe": 8
    }],
    "summeBrutto": 8,
    "agbAkzeptiert": true,
    "dsgvoAkzeptiert": true
  }'
```

### View Logs
All operations are logged to console with prefixes:
- `[Order]` - Order operations
- `[PayPal]` - PayPal operations
- `[Ticket Generation]` - Ticket creation
- `[Email]` - Email sending
- `[Admin]` - Admin operations

## üöÄ Deployment

See `../DEPLOYMENT_GUIDE.md` for detailed deployment instructions.

Quick:
1. Deploy to Render.com or Railway.app
2. Set all environment variables
3. Done!

## üìù License

Private - Verdrehte Welt Event Management
